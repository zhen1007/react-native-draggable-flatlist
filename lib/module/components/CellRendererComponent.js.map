{"version":3,"names":["React","useEffect","useMemo","useRef","findNodeHandle","StyleSheet","Animated","runOnUI","useAnimatedStyle","useSharedValue","useDraggableFlatListContext","isWeb","useCellTranslate","typedMemo","useRefs","useAnimatedValues","CellProvider","useStableCallback","CellRendererComponent","props","item","index","onLayout","children","rest","viewRef","cellDataRef","propsRef","containerRef","horizontalAnim","scrollOffset","activeKey","keyExtractor","horizontal","layoutAnimationDisabled","key","offset","size","heldTanslate","translate","cellOffset","cellSize","cellIndex","isActive","animStyle","value","t","transform","translateX","translateY","updateCellMeasurements","onSuccess","x","y","w","h","current","set","measurements","onFail","debug","console","log","containerNode","viewNode","nodeHandle","measureLayout","onCellLayout","e","requestAnimationFrame","baseStyle","elevation","zIndex","flexDirection","itemEnteringAnimation","itemExitingAnimation","itemLayoutAnimation","enableLayoutAnimationExperimental","tag","_layoutDisabled","config","global","LayoutAnimationRepository","configs","stashConfig","stashedConfig","getStashedConfig","removeConfig","registerConfig","undefined","style","styles","zeroTranslate","create","RNDFLLayoutAnimationConfigStash"],"sources":["CellRendererComponent.tsx"],"sourcesContent":["import React, { useEffect, useMemo, useRef } from \"react\";\r\nimport {\r\n  findNodeHandle,\r\n  LayoutChangeEvent,\r\n  MeasureLayoutOnSuccessCallback,\r\n  StyleProp,\r\n  StyleSheet,\r\n  ViewStyle,\r\n} from \"react-native\";\r\nimport Animated, {\r\n  runOnUI,\r\n  useAnimatedStyle,\r\n  useSharedValue,\r\n} from \"react-native-reanimated\";\r\nimport { useDraggableFlatListContext } from \"../context/draggableFlatListContext\";\r\nimport { isWeb } from \"../constants\";\r\nimport { useCellTranslate } from \"../hooks/useCellTranslate\";\r\nimport { typedMemo } from \"../utils\";\r\nimport { useRefs } from \"../context/refContext\";\r\nimport { useAnimatedValues } from \"../context/animatedValueContext\";\r\nimport CellProvider from \"../context/cellContext\";\r\nimport { useStableCallback } from \"../hooks/useStableCallback\";\r\n\r\ntype Props<T> = {\r\n  item: T;\r\n  index: number;\r\n  children: React.ReactNode;\r\n  onLayout?: (e: LayoutChangeEvent) => void;\r\n  style?: StyleProp<ViewStyle>;\r\n};\r\n\r\nfunction CellRendererComponent<T>(props: Props<T>) {\r\n  const { item, index, onLayout, children, ...rest } = props;\r\n\r\n  const viewRef = useRef<Animated.View>(null);\r\n  const { cellDataRef, propsRef, containerRef } = useRefs<T>();\r\n\r\n  const { horizontalAnim, scrollOffset } = useAnimatedValues();\r\n  const {\r\n    activeKey,\r\n    keyExtractor,\r\n    horizontal,\r\n    layoutAnimationDisabled,\r\n  } = useDraggableFlatListContext<T>();\r\n\r\n  const key = keyExtractor(item, index);\r\n  const offset = useSharedValue(-1);\r\n  const size = useSharedValue(-1);\r\n  const heldTanslate = useSharedValue(0);\r\n\r\n  const translate = useCellTranslate({\r\n    cellOffset: offset,\r\n    cellSize: size,\r\n    cellIndex: index,\r\n  });\r\n\r\n  const isActive = activeKey === key;\r\n\r\n  const animStyle = useAnimatedStyle(() => {\r\n    // When activeKey becomes null at the end of a drag and the list reorders,\r\n    // the animated style may apply before the next paint, causing a flicker.\r\n    // Solution is to hold over the last animated value until the next onLayout.\r\n    // (Not required in web)\r\n    if (translate.value && !isWeb) {\r\n      heldTanslate.value = translate.value;\r\n    }\r\n    const t = activeKey ? translate.value : heldTanslate.value;\r\n    return {\r\n      transform: [horizontalAnim.value ? { translateX: t } : { translateY: t }],\r\n    };\r\n  }, [translate, activeKey]);\r\n\r\n  const updateCellMeasurements = useStableCallback(() => {\r\n    const onSuccess: MeasureLayoutOnSuccessCallback = (x, y, w, h) => {\r\n      if (isWeb && horizontal) x += scrollOffset.value;\r\n      const cellOffset = horizontal ? x : y;\r\n      const cellSize = horizontal ? w : h;\r\n      cellDataRef.current.set(key, {\r\n        measurements: { size: cellSize, offset: cellOffset },\r\n      });\r\n\r\n      size.value = cellSize;\r\n      offset.value = cellOffset;\r\n    };\r\n\r\n    const onFail = () => {\r\n      if (propsRef.current?.debug) {\r\n        console.log(`## on measure fail, index: ${index}`);\r\n      }\r\n    };\r\n\r\n    const containerNode = containerRef.current;\r\n    const viewNode = viewRef.current;\r\n    const nodeHandle = containerNode;\r\n\r\n    if (viewNode && nodeHandle) {\r\n      //@ts-ignore\r\n      viewNode.measureLayout(nodeHandle, onSuccess, onFail);\r\n    }\r\n  });\r\n\r\n  const onCellLayout = useStableCallback((e?: LayoutChangeEvent) => {\r\n    heldTanslate.value = 0;\r\n    updateCellMeasurements();\r\n    if (onLayout && e) onLayout(e);\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (isWeb) {\r\n      // onLayout isn't called on web when the cell index changes, so we manually re-measure\r\n      requestAnimationFrame(() => {\r\n        onCellLayout();\r\n      });\r\n    }\r\n  }, [index, onCellLayout]);\r\n\r\n  const baseStyle = useMemo(() => {\r\n    return {\r\n      elevation: isActive ? 1 : 0,\r\n      zIndex: isActive ? 999 : 0,\r\n      flexDirection: horizontal ? (\"row\" as const) : (\"column\" as const),\r\n    };\r\n  }, [isActive, horizontal]);\r\n\r\n  const {\r\n    itemEnteringAnimation,\r\n    itemExitingAnimation,\r\n    itemLayoutAnimation,\r\n  } = propsRef.current;\r\n\r\n  useEffect(() => {\r\n    // NOTE: Keep an eye on reanimated LayoutAnimation refactor:\r\n    // https://github.com/software-mansion/react-native-reanimated/pull/3332/files\r\n    // We might have to change the way we register/unregister LayouAnimations:\r\n    // - get native module: https://github.com/software-mansion/react-native-reanimated/blob/cf59766460d05eb30357913455318d8a95909468/src/reanimated2/NativeReanimated/NativeReanimated.ts#L18\r\n    // - register layout animation for tag: https://github.com/software-mansion/react-native-reanimated/blob/cf59766460d05eb30357913455318d8a95909468/src/reanimated2/NativeReanimated/NativeReanimated.ts#L99\r\n    if (!propsRef.current.enableLayoutAnimationExperimental) return;\r\n    const tag = findNodeHandle(viewRef.current);\r\n\r\n    runOnUI((t: number | null, _layoutDisabled) => {\r\n      \"worklet\";\r\n      if (!t) return;\r\n      const config = global.LayoutAnimationRepository.configs[t];\r\n      if (config) stashConfig(t, config);\r\n      const stashedConfig = getStashedConfig(t);\r\n      if (_layoutDisabled) {\r\n        global.LayoutAnimationRepository.removeConfig(t);\r\n      } else if (stashedConfig) {\r\n        global.LayoutAnimationRepository.registerConfig(t, stashedConfig);\r\n      }\r\n    })(tag, layoutAnimationDisabled);\r\n  }, [layoutAnimationDisabled]);\r\n\r\n  return (\r\n    <Animated.View\r\n      {...rest}\r\n      ref={viewRef}\r\n      onLayout={onCellLayout}\r\n      entering={itemEnteringAnimation}\r\n      exiting={itemExitingAnimation}\r\n      layout={\r\n        propsRef.current.enableLayoutAnimationExperimental\r\n          ? itemLayoutAnimation\r\n          : undefined\r\n      }\r\n      style={[\r\n        props.style,\r\n        baseStyle,\r\n        activeKey ? animStyle : styles.zeroTranslate,\r\n      ]}\r\n      pointerEvents={activeKey ? \"none\" : \"auto\"}\r\n    >\r\n      <CellProvider isActive={isActive}>{children}</CellProvider>\r\n    </Animated.View>\r\n  );\r\n}\r\n\r\nexport default typedMemo(CellRendererComponent);\r\n\r\nconst styles = StyleSheet.create({\r\n  zeroTranslate: {\r\n    transform: [{ translateX: 0 }, { translateY: 0 }],\r\n  },\r\n});\r\n\r\ndeclare global {\r\n  namespace NodeJS {\r\n    interface Global {\r\n      RNDFLLayoutAnimationConfigStash: Record<string, unknown>;\r\n    }\r\n  }\r\n}\r\n\r\nrunOnUI(() => {\r\n  \"worklet\";\r\n  global.RNDFLLayoutAnimationConfigStash = {};\r\n})();\r\n\r\nfunction stashConfig(tag: number, config: unknown) {\r\n  \"worklet\";\r\n  if (!global.RNDFLLayoutAnimationConfigStash)\r\n    global.RNDFLLayoutAnimationConfigStash = {};\r\n  global.RNDFLLayoutAnimationConfigStash[tag] = config;\r\n}\r\n\r\nfunction getStashedConfig(tag: number) {\r\n  \"worklet\";\r\n  if (!global.RNDFLLayoutAnimationConfigStash) return null;\r\n  return global.RNDFLLayoutAnimationConfigStash[tag] as Record<string, unknown>;\r\n}\r\n"],"mappings":";;AAAA,OAAOA,KAAP,IAAgBC,SAAhB,EAA2BC,OAA3B,EAAoCC,MAApC,QAAkD,OAAlD;AACA,SACEC,cADF,EAKEC,UALF,QAOO,cAPP;AAQA,OAAOC,QAAP,IACEC,OADF,EAEEC,gBAFF,EAGEC,cAHF,QAIO,yBAJP;AAKA,SAASC,2BAAT,QAA4C,qCAA5C;AACA,SAASC,KAAT,QAAsB,cAAtB;AACA,SAASC,gBAAT,QAAiC,2BAAjC;AACA,SAASC,SAAT,QAA0B,UAA1B;AACA,SAASC,OAAT,QAAwB,uBAAxB;AACA,SAASC,iBAAT,QAAkC,iCAAlC;AACA,OAAOC,YAAP,MAAyB,wBAAzB;AACA,SAASC,iBAAT,QAAkC,4BAAlC;;AAUA,SAASC,qBAAT,CAAkCC,KAAlC,EAAmD;EACjD,MAAM;IAAEC,IAAF;IAAQC,KAAR;IAAeC,QAAf;IAAyBC,QAAzB;IAAmC,GAAGC;EAAtC,IAA+CL,KAArD;EAEA,MAAMM,OAAO,GAAGtB,MAAM,CAAgB,IAAhB,CAAtB;EACA,MAAM;IAAEuB,WAAF;IAAeC,QAAf;IAAyBC;EAAzB,IAA0Cd,OAAO,EAAvD;EAEA,MAAM;IAAEe,cAAF;IAAkBC;EAAlB,IAAmCf,iBAAiB,EAA1D;EACA,MAAM;IACJgB,SADI;IAEJC,YAFI;IAGJC,UAHI;IAIJC;EAJI,IAKFxB,2BAA2B,EAL/B;EAOA,MAAMyB,GAAG,GAAGH,YAAY,CAACZ,IAAD,EAAOC,KAAP,CAAxB;EACA,MAAMe,MAAM,GAAG3B,cAAc,CAAC,CAAC,CAAF,CAA7B;EACA,MAAM4B,IAAI,GAAG5B,cAAc,CAAC,CAAC,CAAF,CAA3B;EACA,MAAM6B,YAAY,GAAG7B,cAAc,CAAC,CAAD,CAAnC;EAEA,MAAM8B,SAAS,GAAG3B,gBAAgB,CAAC;IACjC4B,UAAU,EAAEJ,MADqB;IAEjCK,QAAQ,EAAEJ,IAFuB;IAGjCK,SAAS,EAAErB;EAHsB,CAAD,CAAlC;EAMA,MAAMsB,QAAQ,GAAGZ,SAAS,KAAKI,GAA/B;EAEA,MAAMS,SAAS,GAAGpC,gBAAgB,CAAC,MAAM;IACvC;IACA;IACA;IACA;IACA,IAAI+B,SAAS,CAACM,KAAV,IAAmB,CAAClC,KAAxB,EAA+B;MAC7B2B,YAAY,CAACO,KAAb,GAAqBN,SAAS,CAACM,KAA/B;IACD;;IACD,MAAMC,CAAC,GAAGf,SAAS,GAAGQ,SAAS,CAACM,KAAb,GAAqBP,YAAY,CAACO,KAArD;IACA,OAAO;MACLE,SAAS,EAAE,CAAClB,cAAc,CAACgB,KAAf,GAAuB;QAAEG,UAAU,EAAEF;MAAd,CAAvB,GAA2C;QAAEG,UAAU,EAAEH;MAAd,CAA5C;IADN,CAAP;EAGD,CAZiC,EAY/B,CAACP,SAAD,EAAYR,SAAZ,CAZ+B,CAAlC;EAcA,MAAMmB,sBAAsB,GAAGjC,iBAAiB,CAAC,MAAM;IACrD,MAAMkC,SAAyC,GAAG,CAACC,CAAD,EAAIC,CAAJ,EAAOC,CAAP,EAAUC,CAAV,KAAgB;MAChE,IAAI5C,KAAK,IAAIsB,UAAb,EAAyBmB,CAAC,IAAItB,YAAY,CAACe,KAAlB;MACzB,MAAML,UAAU,GAAGP,UAAU,GAAGmB,CAAH,GAAOC,CAApC;MACA,MAAMZ,QAAQ,GAAGR,UAAU,GAAGqB,CAAH,GAAOC,CAAlC;MACA7B,WAAW,CAAC8B,OAAZ,CAAoBC,GAApB,CAAwBtB,GAAxB,EAA6B;QAC3BuB,YAAY,EAAE;UAAErB,IAAI,EAAEI,QAAR;UAAkBL,MAAM,EAAEI;QAA1B;MADa,CAA7B;MAIAH,IAAI,CAACQ,KAAL,GAAaJ,QAAb;MACAL,MAAM,CAACS,KAAP,GAAeL,UAAf;IACD,CAVD;;IAYA,MAAMmB,MAAM,GAAG,MAAM;MAAA;;MACnB,yBAAIhC,QAAQ,CAAC6B,OAAb,8CAAI,kBAAkBI,KAAtB,EAA6B;QAC3BC,OAAO,CAACC,GAAR,CAAa,8BAA6BzC,KAAM,EAAhD;MACD;IACF,CAJD;;IAMA,MAAM0C,aAAa,GAAGnC,YAAY,CAAC4B,OAAnC;IACA,MAAMQ,QAAQ,GAAGvC,OAAO,CAAC+B,OAAzB;IACA,MAAMS,UAAU,GAAGF,aAAnB;;IAEA,IAAIC,QAAQ,IAAIC,UAAhB,EAA4B;MAC1B;MACAD,QAAQ,CAACE,aAAT,CAAuBD,UAAvB,EAAmCd,SAAnC,EAA8CQ,MAA9C;IACD;EACF,CA3B+C,CAAhD;EA6BA,MAAMQ,YAAY,GAAGlD,iBAAiB,CAAEmD,CAAD,IAA2B;IAChE9B,YAAY,CAACO,KAAb,GAAqB,CAArB;IACAK,sBAAsB;IACtB,IAAI5B,QAAQ,IAAI8C,CAAhB,EAAmB9C,QAAQ,CAAC8C,CAAD,CAAR;EACpB,CAJqC,CAAtC;EAMAnE,SAAS,CAAC,MAAM;IACd,IAAIU,KAAJ,EAAW;MACT;MACA0D,qBAAqB,CAAC,MAAM;QAC1BF,YAAY;MACb,CAFoB,CAArB;IAGD;EACF,CAPQ,EAON,CAAC9C,KAAD,EAAQ8C,YAAR,CAPM,CAAT;EASA,MAAMG,SAAS,GAAGpE,OAAO,CAAC,MAAM;IAC9B,OAAO;MACLqE,SAAS,EAAE5B,QAAQ,GAAG,CAAH,GAAO,CADrB;MAEL6B,MAAM,EAAE7B,QAAQ,GAAG,GAAH,GAAS,CAFpB;MAGL8B,aAAa,EAAExC,UAAU,GAAI,KAAJ,GAAuB;IAH3C,CAAP;EAKD,CANwB,EAMtB,CAACU,QAAD,EAAWV,UAAX,CANsB,CAAzB;EAQA,MAAM;IACJyC,qBADI;IAEJC,oBAFI;IAGJC;EAHI,IAIFjD,QAAQ,CAAC6B,OAJb;EAMAvD,SAAS,CAAC,MAAM;IACd;IACA;IACA;IACA;IACA;IACA,IAAI,CAAC0B,QAAQ,CAAC6B,OAAT,CAAiBqB,iCAAtB,EAAyD;IACzD,MAAMC,GAAG,GAAG1E,cAAc,CAACqB,OAAO,CAAC+B,OAAT,CAA1B;IAEAjD,OAAO,CAAC,CAACuC,CAAD,EAAmBiC,eAAnB,KAAuC;MAC7C;;MACA,IAAI,CAACjC,CAAL,EAAQ;MACR,MAAMkC,MAAM,GAAGC,MAAM,CAACC,yBAAP,CAAiCC,OAAjC,CAAyCrC,CAAzC,CAAf;MACA,IAAIkC,MAAJ,EAAYI,WAAW,CAACtC,CAAD,EAAIkC,MAAJ,CAAX;MACZ,MAAMK,aAAa,GAAGC,gBAAgB,CAACxC,CAAD,CAAtC;;MACA,IAAIiC,eAAJ,EAAqB;QACnBE,MAAM,CAACC,yBAAP,CAAiCK,YAAjC,CAA8CzC,CAA9C;MACD,CAFD,MAEO,IAAIuC,aAAJ,EAAmB;QACxBJ,MAAM,CAACC,yBAAP,CAAiCM,cAAjC,CAAgD1C,CAAhD,EAAmDuC,aAAnD;MACD;IACF,CAXM,CAAP,CAWGP,GAXH,EAWQ5C,uBAXR;EAYD,CArBQ,EAqBN,CAACA,uBAAD,CArBM,CAAT;EAuBA,oBACE,oBAAC,QAAD,CAAU,IAAV,eACMV,IADN;IAEE,GAAG,EAAEC,OAFP;IAGE,QAAQ,EAAE0C,YAHZ;IAIE,QAAQ,EAAEO,qBAJZ;IAKE,OAAO,EAAEC,oBALX;IAME,MAAM,EACJhD,QAAQ,CAAC6B,OAAT,CAAiBqB,iCAAjB,GACID,mBADJ,GAEIa,SATR;IAWE,KAAK,EAAE,CACLtE,KAAK,CAACuE,KADD,EAELpB,SAFK,EAGLvC,SAAS,GAAGa,SAAH,GAAe+C,MAAM,CAACC,aAH1B,CAXT;IAgBE,aAAa,EAAE7D,SAAS,GAAG,MAAH,GAAY;EAhBtC,iBAkBE,oBAAC,YAAD;IAAc,QAAQ,EAAEY;EAAxB,GAAmCpB,QAAnC,CAlBF,CADF;AAsBD;;AAED,eAAeV,SAAS,CAACK,qBAAD,CAAxB;AAEA,MAAMyE,MAAM,GAAGtF,UAAU,CAACwF,MAAX,CAAkB;EAC/BD,aAAa,EAAE;IACb7C,SAAS,EAAE,CAAC;MAAEC,UAAU,EAAE;IAAd,CAAD,EAAoB;MAAEC,UAAU,EAAE;IAAd,CAApB;EADE;AADgB,CAAlB,CAAf;AAcA1C,OAAO,CAAC,MAAM;EACZ;;EACA0E,MAAM,CAACa,+BAAP,GAAyC,EAAzC;AACD,CAHM,CAAP;;AAKA,SAASV,WAAT,CAAqBN,GAArB,EAAkCE,MAAlC,EAAmD;EACjD;;EACA,IAAI,CAACC,MAAM,CAACa,+BAAZ,EACEb,MAAM,CAACa,+BAAP,GAAyC,EAAzC;EACFb,MAAM,CAACa,+BAAP,CAAuChB,GAAvC,IAA8CE,MAA9C;AACD;;AAED,SAASM,gBAAT,CAA0BR,GAA1B,EAAuC;EACrC;;EACA,IAAI,CAACG,MAAM,CAACa,+BAAZ,EAA6C,OAAO,IAAP;EAC7C,OAAOb,MAAM,CAACa,+BAAP,CAAuChB,GAAvC,CAAP;AACD"}