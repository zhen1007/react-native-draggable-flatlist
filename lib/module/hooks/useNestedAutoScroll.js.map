{"version":3,"names":["runOnJS","useAnimatedReaction","useDerivedValue","useSharedValue","useSafeNestableScrollContainerContext","SCROLL_POSITION_TOLERANCE","useNestedAutoScroll","params","outerScrollOffset","containerSize","scrollableRef","scrollViewSize","DUMMY_VAL","hoverOffset","activeCellSize","autoscrollSpeed","autoscrollThreshold","isDraggingCell","isTouchActiveNative","hoverScreenOffset","value","isScrolledUp","isScrolledDown","distToTopEdge","Math","max","distToBottomEdge","dist","isAtTopEdge","isAtBottomEdge","scrollTarget","cur","prev","scrollToInternal","y","current","scrollTo","animated","isAtEdge","topDisabled","bottomDisabled","isEdgeDisabled","scrollTargetDiff","abs","scrollInProgress","shouldScroll","distFromEdge","speedPct","offset","targetOffset"],"sources":["useNestedAutoScroll.tsx"],"sourcesContent":["import Animated, {\r\n  runOnJS,\r\n  useAnimatedReaction,\r\n  useDerivedValue,\r\n  useSharedValue,\r\n} from \"react-native-reanimated\";\r\nimport { State as GestureState } from \"react-native-gesture-handler\";\r\nimport { useSafeNestableScrollContainerContext } from \"../context/nestableScrollContainerContext\";\r\nimport { SCROLL_POSITION_TOLERANCE } from \"../constants\";\r\n\r\n// This is mostly copied over from the main react-native-draggable-flatlist\r\n// useAutoScroll hook with a few notable exceptions:\r\n// - Since animated values are now coming in via a callback,\r\n//   we won't guarantee they exist (and default them if not).\r\n// - Outer scrollable is a ScrollView, not a FlatList\r\n// TODO: see if we can combine into a single shared `useAutoScroll()` hook\r\n\r\nexport function useNestedAutoScroll(params: {\r\n  activeCellSize?: Animated.SharedValue<number>;\r\n  autoscrollSpeed?: number;\r\n  autoscrollThreshold?: number;\r\n  hoverOffset?: Animated.SharedValue<number>;\r\n  isDraggingCell?: Animated.SharedValue<number>;\r\n  isTouchActiveNative?: Animated.SharedValue<number>;\r\n  panGestureState?: Animated.SharedValue<GestureState | number>;\r\n}) {\r\n  const {\r\n    outerScrollOffset,\r\n    containerSize,\r\n    scrollableRef,\r\n    scrollViewSize,\r\n  } = useSafeNestableScrollContainerContext();\r\n\r\n  const DUMMY_VAL = useSharedValue(0);\r\n\r\n  const {\r\n    hoverOffset = DUMMY_VAL,\r\n    activeCellSize = DUMMY_VAL,\r\n    autoscrollSpeed = 100,\r\n    autoscrollThreshold = 30,\r\n    isDraggingCell = DUMMY_VAL,\r\n    isTouchActiveNative = DUMMY_VAL,\r\n  } = params;\r\n\r\n  const hoverScreenOffset = useDerivedValue(() => {\r\n    return hoverOffset.value - outerScrollOffset.value;\r\n  }, []);\r\n\r\n  const isScrolledUp = useDerivedValue(() => {\r\n    return outerScrollOffset.value - SCROLL_POSITION_TOLERANCE <= 0;\r\n  }, []);\r\n\r\n  const isScrolledDown = useDerivedValue(() => {\r\n    return (\r\n      outerScrollOffset.value + containerSize.value + SCROLL_POSITION_TOLERANCE >=\r\n      scrollViewSize.value\r\n    );\r\n  }, []);\r\n\r\n  const distToTopEdge = useDerivedValue(() => {\r\n    return Math.max(0, hoverScreenOffset.value);\r\n  }, [hoverScreenOffset]);\r\n\r\n  const distToBottomEdge = useDerivedValue(() => {\r\n    const dist = containerSize.value - (hoverScreenOffset.value + activeCellSize.value)\r\n    return Math.max(0, dist);\r\n  }, [hoverScreenOffset, activeCellSize, containerSize]);\r\n\r\n  const isAtTopEdge = useDerivedValue(() => {\r\n    return distToTopEdge.value <= autoscrollThreshold;\r\n  }, []);\r\n\r\n  const isAtBottomEdge = useDerivedValue(() => {\r\n    return distToBottomEdge.value <= autoscrollThreshold;\r\n  });\r\n\r\n  const scrollTarget = useSharedValue(0);\r\n\r\n  useAnimatedReaction(\r\n    () => {\r\n      return isDraggingCell.value;\r\n    },\r\n    (cur, prev) => {\r\n      if (cur && !prev) {\r\n        scrollTarget.value = outerScrollOffset.value;\r\n      }\r\n    },\r\n    [activeCellSize]\r\n  );\r\n\r\n  function scrollToInternal(y: number) {\r\n    scrollableRef.current?.scrollTo({ y, animated: true });\r\n  }\r\n\r\n  useDerivedValue(() => {\r\n    const isAtEdge = isAtTopEdge.value || isAtBottomEdge.value;\r\n    const topDisabled = isAtTopEdge.value && isScrolledUp.value;\r\n    const bottomDisabled = isAtBottomEdge.value && isScrolledDown.value;\r\n    const isEdgeDisabled = topDisabled || bottomDisabled;\r\n\r\n    const scrollTargetDiff = Math.abs(scrollTarget.value - outerScrollOffset.value);\r\n    const scrollInProgress = scrollTargetDiff > SCROLL_POSITION_TOLERANCE;\r\n\r\n    const shouldScroll =\r\n      isAtEdge &&\r\n      !isEdgeDisabled &&\r\n      isDraggingCell.value &&\r\n      isTouchActiveNative.value &&\r\n      !scrollInProgress;\r\n\r\n    const distFromEdge = isAtTopEdge.value\r\n      ? distToTopEdge.value\r\n      : distToBottomEdge.value;\r\n    const speedPct = 1 - distFromEdge / autoscrollThreshold;\r\n    const offset = speedPct * autoscrollSpeed;\r\n    const targetOffset = isAtTopEdge.value\r\n      ? Math.max(0, outerScrollOffset.value - offset)\r\n      : outerScrollOffset.value + offset;\r\n    if (shouldScroll) {\r\n      scrollTarget.value = targetOffset;\r\n      // Reanimated scrollTo is crashing on android. use 'regular' scrollTo until figured out.\r\n      // scrollTo(scrollViewRef, 0, scrollTarget.value, true)\r\n      runOnJS(scrollToInternal)(targetOffset);\r\n    }\r\n  }, [autoscrollSpeed, autoscrollThreshold, isDraggingCell]);\r\n\r\n  return null;\r\n}\r\n"],"mappings":"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"}