{"version":3,"names":["CellRendererComponent","props","item","index","onLayout","children","rest","viewRef","useRef","useRefs","cellDataRef","propsRef","containerRef","useAnimatedValues","horizontalAnim","scrollOffset","useDraggableFlatListContext","activeKey","keyExtractor","horizontal","layoutAnimationDisabled","key","offset","useSharedValue","size","heldTanslate","translate","useCellTranslate","cellOffset","cellSize","cellIndex","isActive","animStyle","useAnimatedStyle","value","isWeb","t","transform","translateX","translateY","updateCellMeasurements","useStableCallback","onSuccess","x","y","w","h","current","set","measurements","onFail","debug","console","log","containerNode","viewNode","nodeHandle","measureLayout","onCellLayout","e","useEffect","requestAnimationFrame","baseStyle","useMemo","elevation","zIndex","flexDirection","itemEnteringAnimation","itemExitingAnimation","itemLayoutAnimation","enableLayoutAnimationExperimental","tag","findNodeHandle","runOnUI","_layoutDisabled","config","global","LayoutAnimationRepository","configs","stashConfig","stashedConfig","getStashedConfig","removeConfig","registerConfig","undefined","style","styles","zeroTranslate","typedMemo","StyleSheet","create","RNDFLLayoutAnimationConfigStash"],"sources":["CellRendererComponent.tsx"],"sourcesContent":["import React, { useEffect, useMemo, useRef } from \"react\";\r\nimport {\r\n  findNodeHandle,\r\n  LayoutChangeEvent,\r\n  MeasureLayoutOnSuccessCallback,\r\n  StyleProp,\r\n  StyleSheet,\r\n  ViewStyle,\r\n} from \"react-native\";\r\nimport Animated, {\r\n  runOnUI,\r\n  useAnimatedStyle,\r\n  useSharedValue,\r\n} from \"react-native-reanimated\";\r\nimport { useDraggableFlatListContext } from \"../context/draggableFlatListContext\";\r\nimport { isWeb } from \"../constants\";\r\nimport { useCellTranslate } from \"../hooks/useCellTranslate\";\r\nimport { typedMemo } from \"../utils\";\r\nimport { useRefs } from \"../context/refContext\";\r\nimport { useAnimatedValues } from \"../context/animatedValueContext\";\r\nimport CellProvider from \"../context/cellContext\";\r\nimport { useStableCallback } from \"../hooks/useStableCallback\";\r\n\r\ntype Props<T> = {\r\n  item: T;\r\n  index: number;\r\n  children: React.ReactNode;\r\n  onLayout?: (e: LayoutChangeEvent) => void;\r\n  style?: StyleProp<ViewStyle>;\r\n};\r\n\r\nfunction CellRendererComponent<T>(props: Props<T>) {\r\n  const { item, index, onLayout, children, ...rest } = props;\r\n\r\n  const viewRef = useRef<Animated.View>(null);\r\n  const { cellDataRef, propsRef, containerRef } = useRefs<T>();\r\n\r\n  const { horizontalAnim, scrollOffset } = useAnimatedValues();\r\n  const {\r\n    activeKey,\r\n    keyExtractor,\r\n    horizontal,\r\n    layoutAnimationDisabled,\r\n  } = useDraggableFlatListContext<T>();\r\n\r\n  const key = keyExtractor(item, index);\r\n  const offset = useSharedValue(-1);\r\n  const size = useSharedValue(-1);\r\n  const heldTanslate = useSharedValue(0);\r\n\r\n  const translate = useCellTranslate({\r\n    cellOffset: offset,\r\n    cellSize: size,\r\n    cellIndex: index,\r\n  });\r\n\r\n  const isActive = activeKey === key;\r\n\r\n  const animStyle = useAnimatedStyle(() => {\r\n    // When activeKey becomes null at the end of a drag and the list reorders,\r\n    // the animated style may apply before the next paint, causing a flicker.\r\n    // Solution is to hold over the last animated value until the next onLayout.\r\n    // (Not required in web)\r\n    if (translate.value && !isWeb) {\r\n      heldTanslate.value = translate.value;\r\n    }\r\n    const t = activeKey ? translate.value : heldTanslate.value;\r\n    return {\r\n      transform: [horizontalAnim.value ? { translateX: t } : { translateY: t }],\r\n    };\r\n  }, [translate, activeKey]);\r\n\r\n  const updateCellMeasurements = useStableCallback(() => {\r\n    const onSuccess: MeasureLayoutOnSuccessCallback = (x, y, w, h) => {\r\n      if (isWeb && horizontal) x += scrollOffset.value;\r\n      const cellOffset = horizontal ? x : y;\r\n      const cellSize = horizontal ? w : h;\r\n      cellDataRef.current.set(key, {\r\n        measurements: { size: cellSize, offset: cellOffset },\r\n      });\r\n\r\n      size.value = cellSize;\r\n      offset.value = cellOffset;\r\n    };\r\n\r\n    const onFail = () => {\r\n      if (propsRef.current?.debug) {\r\n        console.log(`## on measure fail, index: ${index}`);\r\n      }\r\n    };\r\n\r\n    const containerNode = containerRef.current;\r\n    const viewNode = viewRef.current;\r\n    const nodeHandle = containerNode;\r\n\r\n    if (viewNode && nodeHandle) {\r\n      //@ts-ignore\r\n      viewNode.measureLayout(nodeHandle, onSuccess, onFail);\r\n    }\r\n  });\r\n\r\n  const onCellLayout = useStableCallback((e?: LayoutChangeEvent) => {\r\n    heldTanslate.value = 0;\r\n    updateCellMeasurements();\r\n    if (onLayout && e) onLayout(e);\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (isWeb) {\r\n      // onLayout isn't called on web when the cell index changes, so we manually re-measure\r\n      requestAnimationFrame(() => {\r\n        onCellLayout();\r\n      });\r\n    }\r\n  }, [index, onCellLayout]);\r\n\r\n  const baseStyle = useMemo(() => {\r\n    return {\r\n      elevation: isActive ? 1 : 0,\r\n      zIndex: isActive ? 999 : 0,\r\n      flexDirection: horizontal ? (\"row\" as const) : (\"column\" as const),\r\n    };\r\n  }, [isActive, horizontal]);\r\n\r\n  const {\r\n    itemEnteringAnimation,\r\n    itemExitingAnimation,\r\n    itemLayoutAnimation,\r\n  } = propsRef.current;\r\n\r\n  useEffect(() => {\r\n    // NOTE: Keep an eye on reanimated LayoutAnimation refactor:\r\n    // https://github.com/software-mansion/react-native-reanimated/pull/3332/files\r\n    // We might have to change the way we register/unregister LayouAnimations:\r\n    // - get native module: https://github.com/software-mansion/react-native-reanimated/blob/cf59766460d05eb30357913455318d8a95909468/src/reanimated2/NativeReanimated/NativeReanimated.ts#L18\r\n    // - register layout animation for tag: https://github.com/software-mansion/react-native-reanimated/blob/cf59766460d05eb30357913455318d8a95909468/src/reanimated2/NativeReanimated/NativeReanimated.ts#L99\r\n    if (!propsRef.current.enableLayoutAnimationExperimental) return;\r\n    const tag = findNodeHandle(viewRef.current);\r\n\r\n    runOnUI((t: number | null, _layoutDisabled) => {\r\n      \"worklet\";\r\n      if (!t) return;\r\n      const config = global.LayoutAnimationRepository.configs[t];\r\n      if (config) stashConfig(t, config);\r\n      const stashedConfig = getStashedConfig(t);\r\n      if (_layoutDisabled) {\r\n        global.LayoutAnimationRepository.removeConfig(t);\r\n      } else if (stashedConfig) {\r\n        global.LayoutAnimationRepository.registerConfig(t, stashedConfig);\r\n      }\r\n    })(tag, layoutAnimationDisabled);\r\n  }, [layoutAnimationDisabled]);\r\n\r\n  return (\r\n    <Animated.View\r\n      {...rest}\r\n      ref={viewRef}\r\n      onLayout={onCellLayout}\r\n      entering={itemEnteringAnimation}\r\n      exiting={itemExitingAnimation}\r\n      layout={\r\n        propsRef.current.enableLayoutAnimationExperimental\r\n          ? itemLayoutAnimation\r\n          : undefined\r\n      }\r\n      style={[\r\n        props.style,\r\n        baseStyle,\r\n        activeKey ? animStyle : styles.zeroTranslate,\r\n      ]}\r\n      pointerEvents={activeKey ? \"none\" : \"auto\"}\r\n    >\r\n      <CellProvider isActive={isActive}>{children}</CellProvider>\r\n    </Animated.View>\r\n  );\r\n}\r\n\r\nexport default typedMemo(CellRendererComponent);\r\n\r\nconst styles = StyleSheet.create({\r\n  zeroTranslate: {\r\n    transform: [{ translateX: 0 }, { translateY: 0 }],\r\n  },\r\n});\r\n\r\ndeclare global {\r\n  namespace NodeJS {\r\n    interface Global {\r\n      RNDFLLayoutAnimationConfigStash: Record<string, unknown>;\r\n    }\r\n  }\r\n}\r\n\r\nrunOnUI(() => {\r\n  \"worklet\";\r\n  global.RNDFLLayoutAnimationConfigStash = {};\r\n})();\r\n\r\nfunction stashConfig(tag: number, config: unknown) {\r\n  \"worklet\";\r\n  if (!global.RNDFLLayoutAnimationConfigStash)\r\n    global.RNDFLLayoutAnimationConfigStash = {};\r\n  global.RNDFLLayoutAnimationConfigStash[tag] = config;\r\n}\r\n\r\nfunction getStashedConfig(tag: number) {\r\n  \"worklet\";\r\n  if (!global.RNDFLLayoutAnimationConfigStash) return null;\r\n  return global.RNDFLLayoutAnimationConfigStash[tag] as Record<string, unknown>;\r\n}\r\n"],"mappings":"mWAAA,qDACA,yCAQA,uFAKA,6EACA,uCACA,2DACA,+BACA,iDACA,qEACA,2EACA,6D,mmCAUA,QAASA,sBAAT,CAAkCC,KAAlC,CAAmD,IACzCC,KADyC,CACID,KADJ,CACzCC,IADyC,CACnCC,KADmC,CACIF,KADJ,CACnCE,KADmC,CAC5BC,QAD4B,CACIH,KADJ,CAC5BG,QAD4B,CAClBC,QADkB,CACIJ,KADJ,CAClBI,QADkB,CACLC,IADK,uCACIL,KADJ,yCAGjD,GAAMM,QAAO,CAAG,GAAAC,aAAA,EAAsB,IAAtB,CAAhB,CAHiD,aAID,GAAAC,mBAAA,GAJC,CAIzCC,WAJyC,UAIzCA,WAJyC,CAI5BC,QAJ4B,UAI5BA,QAJ4B,CAIlBC,YAJkB,UAIlBA,YAJkB,wBAMR,GAAAC,uCAAA,GANQ,CAMzCC,cANyC,oBAMzCA,cANyC,CAMzBC,YANyB,oBAMzBA,YANyB,2BAY7C,GAAAC,qDAAA,GAZ6C,CAQ/CC,SAR+C,uBAQ/CA,SAR+C,CAS/CC,YAT+C,uBAS/CA,YAT+C,CAU/CC,UAV+C,uBAU/CA,UAV+C,CAW/CC,uBAX+C,uBAW/CA,uBAX+C,CAcjD,GAAMC,IAAG,CAAGH,YAAY,CAAChB,IAAD,CAAOC,KAAP,CAAxB,CACA,GAAMmB,OAAM,CAAG,GAAAC,qCAAA,EAAe,CAAC,CAAhB,CAAf,CACA,GAAMC,KAAI,CAAG,GAAAD,qCAAA,EAAe,CAAC,CAAhB,CAAb,CACA,GAAME,aAAY,CAAG,GAAAF,qCAAA,EAAe,CAAf,CAArB,CAEA,GAAMG,UAAS,CAAG,GAAAC,kCAAA,EAAiB,CACjCC,UAAU,CAAEN,MADqB,CAEjCO,QAAQ,CAAEL,IAFuB,CAGjCM,SAAS,CAAE3B,KAHsB,CAAjB,CAAlB,CAMA,GAAM4B,SAAQ,CAAGd,SAAS,GAAKI,GAA/B,CAEA,GAAMW,UAAS,CAAG,GAAAC,uCAAA,iCAAuB,CAKvC,GAAIP,SAAS,CAACQ,KAAV,EAAmB,CAACC,gBAAxB,CAA+B,CAC7BV,YAAY,CAACS,KAAb,CAAqBR,SAAS,CAACQ,KAA/B,CACD,CACD,GAAME,EAAC,CAAGnB,SAAS,CAAGS,SAAS,CAACQ,KAAb,CAAqBT,YAAY,CAACS,KAArD,CACA,MAAO,CACLG,SAAS,CAAE,CAACvB,cAAc,CAACoB,KAAf,CAAuB,CAAEI,UAAU,CAAEF,CAAd,CAAvB,CAA2C,CAAEG,UAAU,CAAEH,CAAd,CAA5C,CADN,CAAP,CAGD,CAZiB,wBAhDIV,SAgDJ,OApDMS,gBAoDN,cAhDsBV,YAgDtB,WAhDRR,SAgDQ,gBA9CJH,cA8CI,4dAYf,CAACY,SAAD,CAAYT,SAAZ,CAZe,CAAlB,CAcA,GAAMuB,uBAAsB,CAAG,GAAAC,oCAAA,EAAkB,UAAM,CACrD,GAAMC,UAAyC,CAAG,QAA5CA,UAA4C,CAACC,CAAD,CAAIC,CAAJ,CAAOC,CAAP,CAAUC,CAAV,CAAgB,CAChE,GAAIX,gBAAA,EAAShB,UAAb,CAAyBwB,CAAC,EAAI5B,YAAY,CAACmB,KAAlB,CACzB,GAAMN,WAAU,CAAGT,UAAU,CAAGwB,CAAH,CAAOC,CAApC,CACA,GAAMf,SAAQ,CAAGV,UAAU,CAAG0B,CAAH,CAAOC,CAAlC,CACApC,WAAW,CAACqC,OAAZ,CAAoBC,GAApB,CAAwB3B,GAAxB,CAA6B,CAC3B4B,YAAY,CAAE,CAAEzB,IAAI,CAAEK,QAAR,CAAkBP,MAAM,CAAEM,UAA1B,CADa,CAA7B,EAIAJ,IAAI,CAACU,KAAL,CAAaL,QAAb,CACAP,MAAM,CAACY,KAAP,CAAeN,UAAf,CACD,CAVD,CAYA,GAAMsB,OAAM,CAAG,QAATA,OAAS,EAAM,uBACnB,sBAAIvC,QAAQ,CAACoC,OAAb,SAAI,kBAAkBI,KAAtB,CAA6B,CAC3BC,OAAO,CAACC,GAAR,+BAA0ClD,KAA1C,EACD,CACF,CAJD,CAMA,GAAMmD,cAAa,CAAG1C,YAAY,CAACmC,OAAnC,CACA,GAAMQ,SAAQ,CAAGhD,OAAO,CAACwC,OAAzB,CACA,GAAMS,WAAU,CAAGF,aAAnB,CAEA,GAAIC,QAAQ,EAAIC,UAAhB,CAA4B,CAE1BD,QAAQ,CAACE,aAAT,CAAuBD,UAAvB,CAAmCd,SAAnC,CAA8CQ,MAA9C,EACD,CACF,CA3B8B,CAA/B,CA6BA,GAAMQ,aAAY,CAAG,GAAAjB,oCAAA,EAAkB,SAACkB,CAAD,CAA2B,CAChElC,YAAY,CAACS,KAAb,CAAqB,CAArB,CACAM,sBAAsB,GACtB,GAAIpC,QAAQ,EAAIuD,CAAhB,CAAmBvD,QAAQ,CAACuD,CAAD,CAAR,CACpB,CAJoB,CAArB,CAMA,GAAAC,gBAAA,EAAU,UAAM,CACd,GAAIzB,gBAAJ,CAAW,CAET0B,qBAAqB,CAAC,UAAM,CAC1BH,YAAY,GACb,CAFoB,CAArB,CAGD,CACF,CAPD,CAOG,CAACvD,KAAD,CAAQuD,YAAR,CAPH,EASA,GAAMI,UAAS,CAAG,GAAAC,cAAA,EAAQ,UAAM,CAC9B,MAAO,CACLC,SAAS,CAAEjC,QAAQ,CAAG,CAAH,CAAO,CADrB,CAELkC,MAAM,CAAElC,QAAQ,CAAG,GAAH,CAAS,CAFpB,CAGLmC,aAAa,CAAE/C,UAAU,CAAI,KAAJ,CAAuB,QAH3C,CAAP,CAKD,CANiB,CAMf,CAACY,QAAD,CAAWZ,UAAX,CANe,CAAlB,CArFiD,uBAiG7CR,QAAQ,CAACoC,OAjGoC,CA8F/CoB,qBA9F+C,oBA8F/CA,qBA9F+C,CA+F/CC,oBA/F+C,oBA+F/CA,oBA/F+C,CAgG/CC,mBAhG+C,oBAgG/CA,mBAhG+C,CAmGjD,GAAAT,gBAAA,EAAU,UAAM,CAMd,GAAI,CAACjD,QAAQ,CAACoC,OAAT,CAAiBuB,iCAAtB,CAAyD,OACzD,GAAMC,IAAG,CAAG,GAAAC,2BAAA,EAAejE,OAAO,CAACwC,OAAvB,CAAZ,CAEA,GAAA0B,8BAAA,gCAASrC,CAAT,CAA2BsC,eAA3B,CAA+C,CAE7C,GAAI,CAACtC,CAAL,CAAQ,OACR,GAAMuC,OAAM,CAAGC,MAAM,CAACC,yBAAP,CAAiCC,OAAjC,CAAyC1C,CAAzC,CAAf,CACA,GAAIuC,MAAJ,CAAYI,WAAW,CAAC3C,CAAD,CAAIuC,MAAJ,CAAX,CACZ,GAAMK,cAAa,CAAGC,gBAAgB,CAAC7C,CAAD,CAAtC,CACA,GAAIsC,eAAJ,CAAqB,CACnBE,MAAM,CAACC,yBAAP,CAAiCK,YAAjC,CAA8C9C,CAA9C,EACD,CAFD,IAEO,IAAI4C,aAAJ,CAAmB,CACxBJ,MAAM,CAACC,yBAAP,CAAiCM,cAAjC,CAAgD/C,CAAhD,CAAmD4C,aAAnD,EACD,CACF,CAXD,0BAvIUD,WAuIV,kBAtIoBE,gBAsIpB,kjBAWGV,GAXH,CAWQnD,uBAXR,EAYD,CArBD,CAqBG,CAACA,uBAAD,CArBH,EAuBA,MACE,8BAAC,8BAAD,CAAU,IAAV,0BACMd,IADN,EAEE,GAAG,CAAEC,OAFP,CAGE,QAAQ,CAAEmD,YAHZ,CAIE,QAAQ,CAAES,qBAJZ,CAKE,OAAO,CAAEC,oBALX,CAME,MAAM,CACJzD,QAAQ,CAACoC,OAAT,CAAiBuB,iCAAjB,CACID,mBADJ,CAEIe,SATR,CAWE,KAAK,CAAE,CACLnF,KAAK,CAACoF,KADD,CAELvB,SAFK,CAGL7C,SAAS,CAAGe,SAAH,CAAesD,MAAM,CAACC,aAH1B,CAXT,CAgBE,aAAa,CAAEtE,SAAS,CAAG,MAAH,CAAY,MAhBtC,8EAkBE,6BAAC,oBAAD,EAAc,QAAQ,CAAEc,QAAxB,6EAAmC1B,QAAnC,CAlBF,CADF,CAsBD,C,aAEc,GAAAmF,gBAAA,EAAUxF,qBAAV,C,0BAEf,GAAMsF,OAAM,CAAGG,uBAAA,CAAWC,MAAX,CAAkB,CAC/BH,aAAa,CAAE,CACblD,SAAS,CAAE,CAAC,CAAEC,UAAU,CAAE,CAAd,CAAD,CAAoB,CAAEC,UAAU,CAAE,CAAd,CAApB,CADE,CADgB,CAAlB,CAAf,CAcA,GAAAkC,8BAAA,iCAAc,CAEZG,MAAM,CAACe,+BAAP,CAAyC,EAAzC,CACD,CAHD,uP,GAKSZ,Y,+BAAYR,G,CAAaI,M,CAAiB,CAEjD,GAAI,CAACC,MAAM,CAACe,+BAAZ,CACEf,MAAM,CAACe,+BAAP,CAAyC,EAAzC,CACFf,MAAM,CAACe,+BAAP,CAAuCpB,GAAvC,EAA8CI,MAA9C,CACD,C,sWAEQM,iB,+BAAiBV,G,CAAa,CAErC,GAAI,CAACK,MAAM,CAACe,+BAAZ,CAA6C,MAAO,KAAP,CAC7C,MAAOf,OAAM,CAACe,+BAAP,CAAuCpB,GAAvC,CAAP,CACD,C"}