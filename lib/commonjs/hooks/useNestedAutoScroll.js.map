{"version":3,"names":["useNestedAutoScroll","params","useSafeNestableScrollContainerContext","outerScrollOffset","containerSize","scrollableRef","scrollViewSize","DUMMY_VAL","useSharedValue","hoverOffset","activeCellSize","autoscrollSpeed","autoscrollThreshold","isDraggingCell","isTouchActiveNative","hoverScreenOffset","useDerivedValue","value","isScrolledUp","SCROLL_POSITION_TOLERANCE","isScrolledDown","distToTopEdge","Math","max","distToBottomEdge","dist","isAtTopEdge","isAtBottomEdge","scrollTarget","useAnimatedReaction","cur","prev","scrollToInternal","y","current","scrollTo","animated","isAtEdge","topDisabled","bottomDisabled","isEdgeDisabled","scrollTargetDiff","abs","scrollInProgress","shouldScroll","distFromEdge","speedPct","offset","targetOffset","runOnJS"],"sources":["useNestedAutoScroll.tsx"],"sourcesContent":["import Animated, {\r\n  runOnJS,\r\n  useAnimatedReaction,\r\n  useDerivedValue,\r\n  useSharedValue,\r\n} from \"react-native-reanimated\";\r\nimport { State as GestureState } from \"react-native-gesture-handler\";\r\nimport { useSafeNestableScrollContainerContext } from \"../context/nestableScrollContainerContext\";\r\nimport { SCROLL_POSITION_TOLERANCE } from \"../constants\";\r\n\r\n// This is mostly copied over from the main react-native-draggable-flatlist\r\n// useAutoScroll hook with a few notable exceptions:\r\n// - Since animated values are now coming in via a callback,\r\n//   we won't guarantee they exist (and default them if not).\r\n// - Outer scrollable is a ScrollView, not a FlatList\r\n// TODO: see if we can combine into a single shared `useAutoScroll()` hook\r\n\r\nexport function useNestedAutoScroll(params: {\r\n  activeCellSize?: Animated.SharedValue<number>;\r\n  autoscrollSpeed?: number;\r\n  autoscrollThreshold?: number;\r\n  hoverOffset?: Animated.SharedValue<number>;\r\n  isDraggingCell?: Animated.SharedValue<number>;\r\n  isTouchActiveNative?: Animated.SharedValue<number>;\r\n  panGestureState?: Animated.SharedValue<GestureState | number>;\r\n}) {\r\n  const {\r\n    outerScrollOffset,\r\n    containerSize,\r\n    scrollableRef,\r\n    scrollViewSize,\r\n  } = useSafeNestableScrollContainerContext();\r\n\r\n  const DUMMY_VAL = useSharedValue(0);\r\n\r\n  const {\r\n    hoverOffset = DUMMY_VAL,\r\n    activeCellSize = DUMMY_VAL,\r\n    autoscrollSpeed = 100,\r\n    autoscrollThreshold = 30,\r\n    isDraggingCell = DUMMY_VAL,\r\n    isTouchActiveNative = DUMMY_VAL,\r\n  } = params;\r\n\r\n  const hoverScreenOffset = useDerivedValue(() => {\r\n    return hoverOffset.value - outerScrollOffset.value;\r\n  }, []);\r\n\r\n  const isScrolledUp = useDerivedValue(() => {\r\n    return outerScrollOffset.value - SCROLL_POSITION_TOLERANCE <= 0;\r\n  }, []);\r\n\r\n  const isScrolledDown = useDerivedValue(() => {\r\n    return (\r\n      outerScrollOffset.value + containerSize.value + SCROLL_POSITION_TOLERANCE >=\r\n      scrollViewSize.value\r\n    );\r\n  }, []);\r\n\r\n  const distToTopEdge = useDerivedValue(() => {\r\n    return Math.max(0, hoverScreenOffset.value);\r\n  }, [hoverScreenOffset]);\r\n\r\n  const distToBottomEdge = useDerivedValue(() => {\r\n    const dist = containerSize.value - (hoverScreenOffset.value + activeCellSize.value)\r\n    return Math.max(0, dist);\r\n  }, [hoverScreenOffset, activeCellSize, containerSize]);\r\n\r\n  const isAtTopEdge = useDerivedValue(() => {\r\n    return distToTopEdge.value <= autoscrollThreshold;\r\n  }, []);\r\n\r\n  const isAtBottomEdge = useDerivedValue(() => {\r\n    return distToBottomEdge.value <= autoscrollThreshold;\r\n  });\r\n\r\n  const scrollTarget = useSharedValue(0);\r\n\r\n  useAnimatedReaction(\r\n    () => {\r\n      return isDraggingCell.value;\r\n    },\r\n    (cur, prev) => {\r\n      if (cur && !prev) {\r\n        scrollTarget.value = outerScrollOffset.value;\r\n      }\r\n    },\r\n    [activeCellSize]\r\n  );\r\n\r\n  function scrollToInternal(y: number) {\r\n    scrollableRef.current?.scrollTo({ y, animated: true });\r\n  }\r\n\r\n  useDerivedValue(() => {\r\n    const isAtEdge = isAtTopEdge.value || isAtBottomEdge.value;\r\n    const topDisabled = isAtTopEdge.value && isScrolledUp.value;\r\n    const bottomDisabled = isAtBottomEdge.value && isScrolledDown.value;\r\n    const isEdgeDisabled = topDisabled || bottomDisabled;\r\n\r\n    const scrollTargetDiff = Math.abs(scrollTarget.value - outerScrollOffset.value);\r\n    const scrollInProgress = scrollTargetDiff > SCROLL_POSITION_TOLERANCE;\r\n\r\n    const shouldScroll =\r\n      isAtEdge &&\r\n      !isEdgeDisabled &&\r\n      isDraggingCell.value &&\r\n      isTouchActiveNative.value &&\r\n      !scrollInProgress;\r\n\r\n    const distFromEdge = isAtTopEdge.value\r\n      ? distToTopEdge.value\r\n      : distToBottomEdge.value;\r\n    const speedPct = 1 - distFromEdge / autoscrollThreshold;\r\n    const offset = speedPct * autoscrollSpeed;\r\n    const targetOffset = isAtTopEdge.value\r\n      ? Math.max(0, outerScrollOffset.value - offset)\r\n      : outerScrollOffset.value + offset;\r\n    if (shouldScroll) {\r\n      scrollTarget.value = targetOffset;\r\n      // Reanimated scrollTo is crashing on android. use 'regular' scrollTo until figured out.\r\n      // scrollTo(scrollViewRef, 0, scrollTarget.value, true)\r\n      runOnJS(scrollToInternal)(targetOffset);\r\n    }\r\n  }, [autoscrollSpeed, autoscrollThreshold, isDraggingCell]);\r\n\r\n  return null;\r\n}\r\n"],"mappings":"yGAAA,8DAOA,yFACA,uCASO,QAASA,oBAAT,CAA6BC,MAA7B,CAQJ,2BAMG,GAAAC,qEAAA,GANH,CAECC,iBAFD,uBAECA,iBAFD,CAGCC,aAHD,uBAGCA,aAHD,CAICC,aAJD,uBAICA,aAJD,CAKCC,cALD,uBAKCA,cALD,CAQD,GAAMC,UAAS,CAAG,GAAAC,qCAAA,EAAe,CAAf,CAAlB,CARC,wBAiBGP,MAjBH,CAWCQ,WAXD,CAWCA,WAXD,8BAWeF,SAXf,2CAiBGN,MAjBH,CAYCS,cAZD,CAYCA,cAZD,gCAYkBH,SAZlB,6CAiBGN,MAjBH,CAaCU,eAbD,CAaCA,eAbD,gCAamB,GAbnB,6CAiBGV,MAjBH,CAcCW,mBAdD,CAcCA,mBAdD,gCAcuB,EAdvB,6CAiBGX,MAjBH,CAeCY,cAfD,CAeCA,cAfD,gCAekBN,SAflB,6CAiBGN,MAjBH,CAgBCa,mBAhBD,CAgBCA,mBAhBD,gCAgBuBP,SAhBvB,uBAmBD,GAAMQ,kBAAiB,CAAG,GAAAC,sCAAA,iCAAsB,CAC9C,MAAOP,YAAW,CAACQ,KAAZ,CAAoBd,iBAAiB,CAACc,KAA7C,CACD,CAFyB,0BA1CnBR,WA0CmB,mBA1CCN,iBA0CD,6RAEvB,EAFuB,CAA1B,CAIA,GAAMe,aAAY,CAAG,GAAAF,sCAAA,iCAAsB,CACzC,MAAOb,kBAAiB,CAACc,KAAlB,CAA0BE,oCAA1B,EAAuD,CAA9D,CACD,CAFoB,gCA9CdhB,iBA8Cc,2BA9CYgB,oCA8CZ,sTAElB,EAFkB,CAArB,CAIA,GAAMC,eAAc,CAAG,GAAAJ,sCAAA,iCAAsB,CAC3C,MACEb,kBAAiB,CAACc,KAAlB,CAA0Bb,aAAa,CAACa,KAAxC,CAAgDE,oCAAhD,EACAb,cAAc,CAACW,KAFjB,CAID,CALsB,gCAlDhBd,iBAkDgB,eAlDUC,aAkDV,2BAlDgCe,oCAkDhC,gBAlD6Db,cAkD7D,0XAKpB,EALoB,CAAvB,CAOA,GAAMe,cAAa,CAAG,GAAAL,sCAAA,iCAAsB,CAC1C,MAAOM,KAAI,CAACC,GAAL,CAAS,CAAT,CAAYR,iBAAiB,CAACE,KAA9B,CAAP,CACD,CAFqB,gCAzDHF,iBAyDG,0QAEnB,CAACA,iBAAD,CAFmB,CAAtB,CAIA,GAAMS,iBAAgB,CAAG,GAAAR,sCAAA,iCAAsB,CAC7C,GAAMS,KAAI,CAAGrB,aAAa,CAACa,KAAd,EAAuBF,iBAAiB,CAACE,KAAlB,CAA0BP,cAAc,CAACO,KAAhE,CAAb,CACA,MAAOK,KAAI,CAACC,GAAL,CAAS,CAAT,CAAYE,IAAZ,CAAP,CACD,CAHwB,4BA7DZrB,aA6DY,mBA7DWW,iBA6DX,gBA7DqCL,cA6DrC,mWAGtB,CAACK,iBAAD,CAAoBL,cAApB,CAAoCN,aAApC,CAHsB,CAAzB,CAKA,GAAMsB,YAAW,CAAG,GAAAV,sCAAA,iCAAsB,CACxC,MAAOK,cAAa,CAACJ,KAAd,EAAuBL,mBAA9B,CACD,CAFmB,4BAlEbS,aAkEa,qBAlEUT,mBAkEV,8RAEjB,EAFiB,CAApB,CAIA,GAAMe,eAAc,CAAG,GAAAX,sCAAA,iCAAsB,CAC3C,MAAOQ,iBAAgB,CAACP,KAAjB,EAA0BL,mBAAjC,CACD,CAFsB,+BAtEhBY,gBAsEgB,qBAtEUZ,mBAsEV,sSAAvB,CAIA,GAAMgB,aAAY,CAAG,GAAApB,qCAAA,EAAe,CAAf,CAArB,CAEA,GAAAqB,0CAAA,iCACQ,CACJ,MAAOhB,eAAc,CAACI,KAAtB,CACD,CAHH,6BA5EOJ,cA4EP,sRAIGiB,GAJH,CAIQC,IAJR,CAIiB,CACb,GAAID,GAAG,EAAI,CAACC,IAAZ,CAAkB,CAChBH,YAAY,CAACX,KAAb,CAAqBd,iBAAiB,CAACc,KAAvC,CACD,CACF,CARH,2BA3EEW,YA2EF,mBA3EuBzB,iBA2EvB,8SASE,CAACO,cAAD,CATF,EAYA,QAASsB,iBAAT,CAA0BC,CAA1B,CAAqC,2BACnC,uBAAA5B,aAAa,CAAC6B,OAAd,qCAAuBC,QAAvB,CAAgC,CAAEF,CAAC,CAADA,CAAF,CAAKG,QAAQ,CAAE,IAAf,CAAhC,EACD,CAED,GAAApB,sCAAA,iCAAsB,CACpB,GAAMqB,SAAQ,CAAGX,WAAW,CAACT,KAAZ,EAAqBU,cAAc,CAACV,KAArD,CACA,GAAMqB,YAAW,CAAGZ,WAAW,CAACT,KAAZ,EAAqBC,YAAY,CAACD,KAAtD,CACA,GAAMsB,eAAc,CAAGZ,cAAc,CAACV,KAAf,EAAwBG,cAAc,CAACH,KAA9D,CACA,GAAMuB,eAAc,CAAGF,WAAW,EAAIC,cAAtC,CAEA,GAAME,iBAAgB,CAAGnB,IAAI,CAACoB,GAAL,CAASd,YAAY,CAACX,KAAb,CAAqBd,iBAAiB,CAACc,KAAhD,CAAzB,CACA,GAAM0B,iBAAgB,CAAGF,gBAAgB,CAAGtB,oCAA5C,CAEA,GAAMyB,aAAY,CAChBP,QAAQ,EACR,CAACG,cADD,EAEA3B,cAAc,CAACI,KAFf,EAGAH,mBAAmB,CAACG,KAHpB,EAIA,CAAC0B,gBALH,CAOA,GAAME,aAAY,CAAGnB,WAAW,CAACT,KAAZ,CACjBI,aAAa,CAACJ,KADG,CAEjBO,gBAAgB,CAACP,KAFrB,CAGA,GAAM6B,SAAQ,CAAG,EAAID,YAAY,CAAGjC,mBAApC,CACA,GAAMmC,OAAM,CAAGD,QAAQ,CAAGnC,eAA1B,CACA,GAAMqC,aAAY,CAAGtB,WAAW,CAACT,KAAZ,CACjBK,IAAI,CAACC,GAAL,CAAS,CAAT,CAAYpB,iBAAiB,CAACc,KAAlB,CAA0B8B,MAAtC,CADiB,CAEjB5C,iBAAiB,CAACc,KAAlB,CAA0B8B,MAF9B,CAGA,GAAIH,YAAJ,CAAkB,CAChBhB,YAAY,CAACX,KAAb,CAAqB+B,YAArB,CAGA,GAAAC,8BAAA,EAAQjB,gBAAR,EAA0BgB,YAA1B,EACD,CACF,CA9BD,0BAlFqBtB,WAkFrB,gBA1FuBC,cA0FvB,cA3FyCT,YA2FzC,gBA1F+CE,cA0F/C,cA/EEQ,YA+EF,mBAlFyFzB,iBAkFzF,2BAvF4CgB,oCAuF5C,gBAtFoDN,cAsFpD,qBAtF4EC,mBAsF5E,eArFyCO,aAqFzC,kBArF+DG,gBAqF/D,qBApFoCZ,mBAoFpC,iBAnF0BD,eAmF1B,SA5EEsC,8BA4EF,kBA5EUjB,gBA4EV,4wCA8BG,CAACrB,eAAD,CAAkBC,mBAAlB,CAAuCC,cAAvC,CA9BH,EAgCA,MAAO,KAAP,CACD"}